<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Entity Relationship Explorer</title>
</head>
<body>
  <p>Please select a schema description data file</p>
  <form>
    <!--
      the one and only event generator which drives this little utility:
      selecting a file with this input fires off code to load the JSON,
      and generate the rest of the page accordingly.
    -->
    <input
        type="file"
        id="file"
        onchange="load_sel( this.files )"
    >
  </form>
  <h1 id="fname"></h1>
  <ul id="tnames"></ul>
  <div id="tdetails"></div>
  <script>

    // @formatter:off
    //
    // If the setting above, AND, a corresponding preference / configuration are enabled,
    // IntelliJ will try to "help" you format your code LESS (some of us detest its auto-formatting).
    // see:  https://www.google.com/webhp?sourceid=chrome-instant&ion=1&espv=2&ie=UTF-8#q=intellij+disable+auto+format&*
    // e.g. -
    //      http://www.gamefromscratch.com/post/2015/02/01/Preventing-IntelliJ-code-auto-formatting-from-ruining-your-day.aspx
    //      http://stackoverflow.com/questions/3375307/how-to-disable-code-formatting-for-some-part-of-the-code-using-comments

    /** return anchor name based on table name */
    const get_anchor = ( tname ) => (
      `tb_${ tname }`
    )

    /** generate a new element, with optional text or attributes */
    const gen_el_w_text = function ( type, text, attrs ) {
      var el = document.createElement( type )
      el.textContent = text
      if ( attrs ) {
        Object.getOwnPropertyNames(
          attrs
        ).forEach( function( attr ) {
          el.setAttribute(
            attr,
            attrs[ attr ]
          )
        } )
      } // else: no attributes to add
      return el
    }

    /** generate a new element, nested element(s) */
    const gen_el_w_nest = function ( type, child_els ) {
      var el = document.createElement( type )
      if ( child_els.forEach ) {
        child_els.forEach( function ( child ) {
          el.appendChild( child )
        } )
      } else {
        el.appendChild( child_els )
      }
      return el
    }

    /** map the input array and append the result to the given anchor */
    const append_map = function ( mapper, anchor_el, in_objs ) {
      in_objs.forEach( function ( obj) {
        anchor_el.appendChild(
          mapper( obj )
        )
      } )
    }

    /** generate an entry in the list of table names */
    const gen_table_index = function ( table ) {
      console.log( table )
      return gen_el_w_nest(
        'li',
        gen_el_w_text(
          'a',
          table.name,
          { href: '#' + get_anchor( table.name ) }
        )
      )
    }

    /** generate an entry in the details of table names */
    const gen_table_detail = function ( table ) {
      console.log( table )
      // TODO - outer div with a name anchor to link to
      return gen_el_w_nest(
        'div',
        [
          gen_el_w_text(
            'a',
            null,
            { name: get_anchor( table.name ) }
          ),
          gen_el_w_nest(
            'table',
            gen_el_w_nest(
              'tbody',
              gen_el_w_nest(
                'tr',
                gen_el_w_text(
                  'td',
                  table.name
                )
              )
            )
          )
        ]
      )
      // TODO - list references from, and to
    }

    /** interpret the schema description object */
    const display_schema = function ( schema ) {
      var tnames = document.getElementById( 'tnames' )
      tnames.textContent = null
      append_map(
        gen_table_index,
        tnames,
        schema.tables // TODO - sort tables (Ramda?)
      )
      var tdetails = document.getElementById( 'tdetails' )
      tdetails.textContent = null
      append_map(
        gen_table_detail,
        tdetails,
        schema.tables
      )
      // TODO - check for top level related schemas with their own (related) tables
    }

    /** Load the selected file (first item in given list). */
    const load_sel = function ( files ) {
      try {
        const sel_file = files[ 0 ]
        console.log( sel_file )
        document.getElementById(
          'fname'
        ).textContent = sel_file.name
        sel_file.text().then( function ( text ) {
          const schema = JSON.parse( text )
          console.log( schema )
          display_schema( schema )
        } )
      } catch ( e ) {
        console.error( e )
      }
    }

  </script>
</body>
</html>